# Домашнее задание к занятию 12.09 "Базы данных в облаке"

Домашнее задание выполните в Google Docs и отправьте в личном кабинете на проверку ссылку на ваш документ.

Название файла должно содержать номер лекции и фамилию студента. Пример названия: "12.9 Базы данных в облаке - Александр Волянский"

Перед тем как выслать ссылку, убедитесь, что ее содержимое не является приватным (открыто на просмотр всем, у кого есть ссылка). Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.

---

Домашнее задание подразумевает, что вы уже делали предыдущие работы в Яндекс.Облаке, и у вас есть аккаунт и каталог.


Используйте следующие рекомендации во избежание лишних трат в Яндекс.Облаке:
1) Сразу после выполнения задания удалите кластер;
2) Если вы решили взять паузу на выполнение задания, то остановите кластер.

### Задание 1


#### Создание кластера
1. Перейдите на главную страницу сервиса Managed Service for PostgreSQL.
1. Создайте кластер PostgreSQL со следующими параметрами:
- Класс хоста: s2.micro, диск network-ssd любого размера;
- Хосты: нужно создать два хоста в двух  разных зонах доступности  и указать необходимость публичного доступа (публичного IP адреса) для них;
- Установите учетную запись для пользователя и базы.

Остальные параметры оставьте по умолчанию либо измените по своему усмотрению.

* Нажмите кнопку "Создать кластер" и дождитесь окончания процесса создания (Статус кластера = RUNNING). Кластер создается от 5 до 10 минут.

![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/1.png)

![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/2.png)


#### Подключение к мастеру и реплике 

* Используйте инструкцию по подключению к кластеру, доступную на вкладке "Обзор": cкачайте SSL сертификат и подключитесь к кластеру с помощью утилиты psql, указав hostname всех узлов и атрибут ```target_session_attrs=read-write```.

* Проверьте, что подключение прошло к master-узлу.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/3.png)

* Посмотрите количество подключенных реплик:
```
select count(*) from pg_stat_replication;
```
![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/4.png)

### Проверьте работоспособность репликации в кластере

* Создайте таблицу и вставьте одну-две строки.
```
CREATE TABLE test_table(text varchar);
```

![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/5.png)

```
insert into test_table values('Строка 1');
```
![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/6.png)

* Выйдите из psql командой ```\q```.

* Теперь подключитесь к узлу-реплике. Для этого из команды подключения удалите атрибут ```target_session_attrs``` , и в параметре атрибут ```host``` передайте только имя хоста-реплики. Роли хостов можно посмотреть на соответствующей вкладке UI консоли.

* Проверьте, что подключение прошло к узлу-реплике.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/7.png)

* Проверьте состояние репликации
```
select status from pg_stat_wal_receiver;
```
![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/8.png)


* Для проверки, что механизм репликации данных работает между зонами доступности облака, выполните запрос к таблице, созданной на предыдущем шаге:
```
select * from test_table;
```
![alt tag](https://github.com/avo1yanskiy/slin-homeworks/blob/main/sdb-homeworks/images/12-09/9.png)

По итогу пришлите скриншоты:

1) Созданной базы данных;
2) Результата вывода команды на реплике ```select * from test_table;```.



### Задание 2*

Создайте кластер, как в задании 1 с помощью terraform.


По итогу пришлите скришоты:

1) Скриншот созданной базы данных;
2) Код terraform, создающий базу данных.

---

Задания, помеченные звездочкой * - дополнительные (не обязательные к выполнению) и никак не повлияют на получение вами зачета по этому домашнему заданию. Вы можете их выполнить, если хотите глубже и/или шире разобраться в материале.